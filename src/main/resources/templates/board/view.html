<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">
<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
          crossorigin="anonymous">

    <style>
        .table img {
            max-width: 100%;
            max-height: 400px; /* 이미지의 최대 높이를 설정합니다. 필요에 따라 조절 가능합니다. */
            height: auto;
        }

        .table-container {
            max-width: 800px;
            overflow-x: auto;
            margin-bottom: 15px;
        }
        .comment-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 15px;
    }

    /* 각 댓글에 대한 스타일 */
    .comment {
        background-color: #f2f2f2;
    }

    /* 대댓글을 감싸는 테이블에 대한 스타일 */
    .reply-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    /* 각 대댓글에 대한 스타일 */
    .reply {
        background-color: #e6e6e6;
        margin-left: 20px;
    }
    </style>
</head>
<th:block layout:fragment="script">
    <script th:inline="javascript">
        function showPasswordPopup() {
            document.getElementById('passwordPopup').style.display = 'block';
        }
        function checkPasswordAndProceed() {

            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");

            var enteredPassword = document.getElementById('password').value;


            $.ajax({
                type: 'POST',
                 beforeSend : function(xhr){
                   xhr.setRequestHeader(header, token);
                   },
                url: '/board/checkPassword',
                data: { postId: /*[[${board.id}]]*/, password: enteredPassword },
                success: function (response) {
                    if (response.success) {
                        window.location.href = '/board/update/' + /*[[${board.id}]]*/;
                    } else {
                        alert('비밀번호가 일치하지 않습니다.');
                    }
                },
                error: function (error) {
                    console.error('비밀번호 확인 실패:', error);
                }
            });
        }
    </script>
    <script th:inline="javascript">
        function deletePasswordPopup() {
                 document.getElementById('passwordPopup1').style.display = 'block';
             }
             function deleteBoardAndProceed() {
              var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");
                 var token = $("meta[name='_csrf']").attr("content");
                 var header = $("meta[name='_csrf_header']").attr("content");

                 var enteredPassword = document.getElementById('password1').value;


                 $.ajax({
                     type: 'POST',
                      beforeSend : function(xhr){
                        xhr.setRequestHeader(header, token);
                        },
                     url: '/board/checkPassword',
                     data: { postId: /*[[${board.id}]]*/, password: enteredPassword },
                     success: function (response) {
                         if (response.success) {
                            alert('게시글을 삭제하였습니다');
                            var form = document.getElementById('deleteForm');
                        form.submit();
                         } else {
                             alert('비밀번호가 일치하지 않습니다.');
                         }
                     },
                     error: function (error) {
                         console.error('비밀번호 확인 실패:', error);
                     }
                 });
             }
    </script>
    <script th:inline="javascript">
        window.onload = function () {
    loadComments();
};

function loadComments() {
    var token = $("meta[name='_csrf']").attr("content");
    var header = $("meta[name='_csrf_header']").attr("content");
    const id = [[${board.id}]];

    // Ajax 요청
    $.ajax({
        type: "get",
        beforeSend: function(xhr){
            xhr.setRequestHeader(header, token);
        },
        url: "/comment/getByBoardId/" + id,
        success: function (res) {
            console.log("댓글 목록 가져오기 성공", res);

            // 결과를 처리
            const commentListContainer = document.getElementById('comment-list');
            if (commentListContainer) {
                const output = generateCommentTable(res);
                commentListContainer.innerHTML = output;
            } else {
                console.error("comment-list 엘리먼트를 찾을 수 없습니다.");
            }
        },
        error: function (err) {
            console.error("댓글 목록 가져오기 실패", err);
        }
    });
}



       const commentWrite = () => {
    var token = $("meta[name='_csrf']").attr("content");
    var header = $("meta[name='_csrf_header']").attr("content");

    const writer = document.getElementById("commentWriter").value;
    const contents = document.getElementById("commentContents").value;
    const id = [[${board.id}]];

    // Ajax 요청
    $.ajax({
        type: "post",
        beforeSend: function(xhr){
            xhr.setRequestHeader(header, token);
        },
        url: "/comment/save",
        data: {
            "commentWriter": writer,
            "commentContents": contents,
            "boardId": id
        },
        success: function (res) {
            console.log("요청성공", res);

            // 결과를 처리
            const commentListContainer = document.getElementById('comment-list');
            if (commentListContainer) {
                const output = generateCommentTable(res);
                commentListContainer.innerHTML = output;
                document.getElementById('commentWriter').value = '';
                document.getElementById('commentContents').value = '';
            } else {
                console.error("comment-list 엘리먼트를 찾을 수 없습니다.");
            }
        },
        error: function (err) {
            console.error("요청실패", err);
        }
    });
}
function generateCommentTable(comments) {
    let output = "<table>";
    output += "<tr><th>댓글번호</th>";
    output += "<th>작성자</th>";
    output += "<th>내용</th>";
    output += "<th>작성시간</th>";
    output += "<th>답글</th></tr>";

    for (let i in comments) {
        output += "<tr>";
        output += "<td>" + comments[i].id + "</td>";
        output += "<td>" + comments[i].commentWriter + "</td>";
        output += "<td>" + comments[i].commentContents + "</td>";
        output += "<td>" + comments[i].commentCreatedTime + "</td>";
        output += "<td><button onclick='showReplyForm(" + comments[i].id + ")'>답글</button></td>";
        output += "</tr>";

        // 대댓글 폼 추가
        output += "<tr>";
        output += "<td>";
        output += "<div id='replyForm-" + comments[i].id + "' style='display: none;'>";
        output += "<input type='text' id='replyWriter-" + comments[i].id + "' placeholder='작성자명'>";
        output += "<input type='text' id='replyContents-" + comments[i].id + "' placeholder='답글 내용'>";
        output += "<button onclick='submitReply(" + comments[i].id + ")'>답글 전송</button>";
        output += "</div>";
        output += "</td>";
        output += "</tr>";
    }

    output += "</table>";

    return output; // 함수에서 생성한 HTML을 반환
}
               const listReq = () => {
                   console.log("목록 요청");
                   const page = [[${page}]];
                   location.href = "/board/paging?page="+page;
               }
               const updateReq = () => {
                   console.log("수정 요청");
                   const id = [[${board.id}]];
                   location.href = "/board/update/" + id;
               }
               const deleteReq = () => {
                   console.log("삭제 요청");
                   const id = [[${board.id}]];
                   location.href = "/board/delete/" + id;
               }

        function showReplyForm(commentId) {
            const replyForm = document.getElementById(`replyForm-${commentId}`);
            if (replyForm) {
                replyForm.style.display = 'block';
            }
        }

function submitReply(parentCommentId) {
    var token = $("meta[name='_csrf']").attr("content");
     var header = $("meta[name='_csrf_header']").attr("content");
    const writer = document.getElementById(`replyWriter-${parentCommentId}`).value;
    const contents = document.getElementById(`replyContents-${parentCommentId}`).value;
    const boardId = [[${board.id}]];

    // 백엔드에 대댓글 제출을 위한 AJAX 요청 보내기
    $.ajax({
        type: "post",
        contentType: "application/json",
        beforeSend: function (xhr) {
            xhr.setRequestHeader(header, token);
        },
        url: "/comment/saveReply/" + parentCommentId,
        dataType: "JSON",
       data: JSON.stringify({
           "commentWriter": writer,
           "commentContents": contents,
           "boardId": boardId
        }),
        success: function (res) {
            console.log("대댓글 제출 성공", res);

            // 성공적인 제출 이후에 UI를 업데이트하여 새로운 대댓글을 표시
            const commentListContainer = document.getElementById('comment-list');
            if (commentListContainer) {
                loadComments(); // 댓글 목록을 다시로드하거나 업데이트
            } else {
                console.error("comment-list 엘리먼트를 찾을 수 없습니다.");
            }
        },
        error: function (err) {
            console.error("대댓글 제출 실패", err);
        }
    });
}

   function showReplyForm(commentId) {
   console.log(`showReplyForm called for commentId: ${commentId}`);
    const replyForm = document.getElementById(`replyForm-${commentId}`);
    if (replyForm) {
        replyForm.style.display = 'block';
    }
}
    </script>
</th:block>
<body>
<div layout:fragment="content" class="content-mg">
    <h1>게시판 상세 페이지</h1>

    <div class="table-container">
        <table width="500" cellpadding="0" cellspacing="0" border="1" class="table">
            <tbody class="table-group-divider">
            <h2 th:text="${board.title}"></h2>
            <p th:text="${board.name}"></p>

            <p th:text="${board.content}"></p>
            <div>
                <img th:if="${not #strings.isEmpty(board.imgUrl)}"
                     th:src="${board.imgUrl}" class="rounded mgb-15" width="800" height="auto">
            </div>
            </tbody>
        </table>
    </div>
    <p>
    <form th:action="@{'/board/delete?id=' + ${board.id}}" method="post" id="deleteForm">
        <button type="button" onclick="deletePasswordPopup()">삭제</button>
        <div id="passwordPopup1" style="display: none;">
            <label for="password">비밀번호 입력:</label>
            <input type="password" id="password1">
            <button type="button" onclick="deleteBoardAndProceed()">확인</button>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        </div>
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
    </form>

    <form th:action="@{'/board/update/' + ${board.id}}" method="get">
        <button type="button" onclick="showPasswordPopup()">수정</button>

        <div id="passwordPopup" style="display: none;">
            <label for="password">비밀번호 입력:</label>
            <input type="password" id="password">
            <button type="button" onclick="checkPasswordAndProceed()">확인</button>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        </div>
    </form>
    </p>
    <!-- 댓글 작성 부분 -->
    <div id="comment-write">
        <input type="text" id="commentWriter" placeholder="작성자">
        <input type="text" id="commentContents" placeholder="내용">
        <button id="comment-write-btn" onclick="commentWrite()">댓글작성</button>
    </div>

    <!-- 댓글 출력 부분 -->
    <div id="comment-list" class="comment-table">
        <table>
            <tr>
                <th>댓글번호</th>
                <th>작성자</th>
                <th>내용</th>
                <th>작성시간</th>
            </tr>

            <tr th:each="comment: ${commentList}" class="comment">
                <td th:text="${comment.id}"></td>
                <td th:text="${comment.commentWriter}"></td>
                <td th:text="${comment.commentContents}"></td>
                <td>
                    <span th:text="${#dates.format(comment.commentCreatedTime, 'yyyy-MM-dd')}"></span>
                </td>
                <td>
                    <button onclick="showReplyForm(${comment.id})">답글</button>
                    <div id="replyForm-${comment.id}" style="display: none;">
                        <input type="text" id="replyWriter-${comment.id}" placeholder="작성자명">
                        <input type="text" id="replyContents-${comment.id}" placeholder="답글 내용">
                        <button onclick="submitReply(${comment.id})">답글 전송</button>
                    </div>

                    <!-- 대댓글 표시 -->
                    <table class="reply-table">
                        <tr th:each="reply: ${comment.replies}" class="reply">
                            <td th:text="${reply.id}"></td>
                            <td th:text="${reply.commentWriter}"></td>
                            <td th:text="${reply.commentContents}"></td>
                            <td>
                                <span th:text="${#dates.format(reply.commentCreatedTime, 'yyyy-MM-dd')}"></span>
                            </td>
                        </tr>
                    </table>
                    <div>
                        <input type="text" id="commentWriter-${comment.id}" placeholder="작성자">
                        <input type="text" id="commentContents-${comment.id}" placeholder="내용">
                        <button onclick="submitReply(${comment.id})">댓글 작성</button>
                    </div>
                </td>
            </tr>
        </table>
    </div>
</div>


<div class="footer" th:fragment="content"></div>
</body>
</html>